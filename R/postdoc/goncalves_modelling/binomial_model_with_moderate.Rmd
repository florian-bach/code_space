---
title: "Goncalves Modelling"
author: "Florian Bach"
date: "28/01/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Analysis Plan & Input Data

The aim of this project is to examine whether the data published in Gon√ßalves *et al.* (2014) supports the idea that first infections are more likely to involve severe disease than subsequent infections. In their paper, the authors report that the probability of severe disease given an infection is constant in the first few infections of life, i.e. no immunity to severe disease is rapidly acquired (the null hypothesis). To test this conclusion we will use a binomial distribution fit to the number of observations of first, second, third *etc.* infections and the estimated frequency of severe / moderate disease as reported in the paper. We can then determine the likelihood of the observed frequencies of severe disease given our modelled distributions. The null hypothesis is rejected if the number of severe cases is two standard deviations above/below the mean calculated with the simulation.
In the paper, the number of severe episodes and the total number of infections is reported, forming the basis for this analysis:


```{r include=FALSE}
library(ggplot2)
library(dplyr)

# denominator definition in main paper:
# "the denominator is the total number of children who had the indicated number of infections"

# denominator definition in supp:
# total number of "children that had at least the indicated number of infections"

# so supposedly the denominator from the main figure should be a subset of the supplementary, but it's bigger somehow??

```
```{r data input}
goncalves_data <- data.frame("N_Infection"=seq(0,14),
                             "Severe"=c(0, 32, 18, 20, 9, 9, 2, 2, 8, NA, 1, NA, NA, NA, 1),
                             "Infections"=c(0, 715, 540, 424, 330, 267, 220, 168, 131, NA, 90, NA, NA, NA, 25),
                             "Susceptible"=c(102, 70, 52, 32, 23, 14, 12, 10, 2, 2, 1, 1, 1, 1, 0),
                             "Severe_Moderate"=c(0, 76, 41, 31, 15, 12, 5, 8, 5, 1, 1, 3, NA, NA, 1),
                             "Supp_Infections"=c(0, 715, 501, 369, 276, 213, 169, 120, 86, 62, 55, 47, NA, NA, 25))



```


## The probability of severe disease

Dividing the number of severe disease cases by the total number of cases shows the probability of severe disease decreases with the order of infection. Note not all order of infection have an associated risk, because severe disease wasn't always observed.

The same is done for data about severe+moderate disease instances which are reported in the supplementary.

```{r severe probability plot, echo=FALSE, warning=FALSE, fig.show="hold", out.width="50%"}

severe_disease_bar <- ggplot(goncalves_data, aes(x = N_Infection, y=Severe/Infections))+
  ylab("Risk of Severe Disease\n")+
  scale_y_continuous(label=scales::percent, limits=c(0, 0.13))+
  scale_x_continuous(breaks = seq(0,14, by=1), expand = expansion(add = c(0.2,0)))+
  geom_bar(stat="identity", fill="red", na.rm = TRUE)+
  geom_text(aes(label= paste0("frac(",Severe, ",", Infections,")")),parse = TRUE, vjust= -0.2, data = goncalves_data, size=3.5)+
   ggtitle("Severe Disease\n")+
  #geom_smooth()+
  theme_minimal()+
  theme(plot.title = element_text(size=15, hjust = 0.5),
        axis.text = element_text(size=12),
        axis.title = element_text(size=13.5)
        #plot.margin = unit(c(2,2,2,2), "lines")
        )

moderate_disease_bar <- ggplot(goncalves_data, aes(x = N_Infection, y=Severe_Moderate/Supp_Infections))+
  ylab("\n\nRisk of Severe / Moderate Disease\n")+
  scale_y_continuous(label=scales::percent, limits=c(0, 0.13))+
  scale_x_continuous(breaks = seq(0,14, by=1), expand = expansion(add = c(0.2,0)))+#
  geom_text(aes(label= paste0("frac(",Severe_Moderate, ",", Supp_Infections,")")),parse = TRUE, vjust= -0.2, data = goncalves_data, size=3.5)+
  geom_bar(stat="identity", fill="blue", na.rm = TRUE)+
  ggtitle("Severe / Moderate Disease")+
  theme_minimal()+
  theme(plot.title = element_text(size=15, hjust = 0.5),
        axis.text = element_text(size=12),
        axis.title = element_text(size=13.5)
        #plot.margin = unit(c(2,2,2,2), "lines")
        )

#combo_plot <- cowplot::plot_grid(severe_disease_bar, moderate_disease_bar)

plot(severe_disease_bar)
plot(moderate_disease_bar)
```

```{r only include first 5 infections, include=FALSE}


# here we fix how many orders of infection we want to simulate

goncalves_data$N_Infection_Words <- c("Zero", "First", "Second", "Third", "Fourth", "Fifth", "Sixth", "Seventh", "Eight", "Nineth", "Tenth", "Eleventh", "Twelveth", "Thirteenth", "Fourteenth")

n_infection_colnames <- list("First"=NA,
                       "Second"=NA,
                       "Third"=NA,
                       "Fourth"=NA,
                       "Fifth"=NA,
                       "Sixth"=NA,
                       "Seventh"=NA,
                       "Eight"=NA,
                       "Ninenth"=NA,
                       "Tenth"=NA,
                       "Eleventh"=NA,
                       "Twelveth"=NA,
                       "Thirteenth"=NA,
                       "Fourteenth"=NA)

n_infection_colnames <- n_infection_colnames[1:6]

n_infection_words <- names(n_infection_colnames)

infection_number <- length(n_infection_words)

#calculate fractions of severe disease relative to cases etc.; replace 0 with NA, get rid of no infection row
goncalves_model_data <- goncalves_data %>% replace(is.na(.),0)
goncalves_model_data <- goncalves_model_data[2:(infection_number+1),]


# make empty data.frame for loops
# severe disease
simulation_mean <- data.frame(n_infection_colnames, "Simulation"= rep("Severe Mean", 10000))
simulation_median <- data.frame(n_infection_colnames, "Simulation"=rep("Severe Median", 10000))

#severe/moderate disease
simulation_moderate_mean <- data.frame(n_infection_colnames, "Simulation"=rep("Moderate+Severe Mean", 10000))
simulation_moderate_median <- data.frame(n_infection_colnames, "Simulation"=rep("Moderate+Severe Median", 10000))

#severe/moderate disease with main paper denominators
simulation_moderate_main_denom_mean <- data.frame(n_infection_colnames, "Simulation"=rep("Moderate+Severe Mean\nWith Larger Denominators", 10000))
simulation_moderate_main_denom_median <- data.frame(n_infection_colnames, "Simulation"=rep("Moderate+Severe Median\nWith Larger Denominators", 10000))

#calculate risk for each set of binomial models; this block uses the median/med
# mean_risk <- mean(goncalves_model_data$Severe/goncalves_model_data$Infections, na.rm = TRUE)
# median_risk <- median(goncalves_model_data$Severe/goncalves_model_data$Infections, na.rm = TRUE)
# 
# mean_mod_risk <- mean(goncalves_model_data$Severe_Moderate/goncalves_model_data$Supp_Infections, na.rm = TRUE)
# median_mod_risk <- median(goncalves_model_data$Severe_Moderate/goncalves_model_data$Supp_Infections, na.rm = TRUE)
# 
# mean_mod_risk_main_denom <- mean(goncalves_model_data$Severe_Moderate/goncalves_model_data$Infections, na.rm = TRUE)
# median_mod_risk_main_denom <- median(goncalves_model_data$Severe_Moderate/goncalves_model_data$Infections, na.rm = TRUE)

mean_risk <- sum(goncalves_model_data$Severe, na.rm = TRUE)/sum(goncalves_model_data$Infections, na.rm = TRUE)
median_risk <- median(goncalves_model_data$Severe/goncalves_model_data$Infections, na.rm = TRUE)

mean_mod_risk <- sum(goncalves_model_data$Severe_Moderate, na.rm = TRUE)/sum(goncalves_model_data$Supp_Infections, na.rm = TRUE)
median_mod_risk <- median(goncalves_model_data$Severe_Moderate/goncalves_model_data$Supp_Infections, na.rm = TRUE)

mean_mod_risk_main_denom <- sum(goncalves_model_data$Severe_Moderate, na.rm = TRUE)/sum(goncalves_model_data$Infections, na.rm = TRUE)
median_mod_risk_main_denom <- median(goncalves_model_data$Severe_Moderate/goncalves_model_data$Infections, na.rm = TRUE)

# for loops

for(i in 1:10000){
  new_entry <- rbinom(n=infection_number, size=goncalves_model_data$Infections, prob = mean_risk)
  simulation_mean[i,1:infection_number] <- new_entry
}

for(i in 1:10000){
  new_entry <- rbinom(n=infection_number, size=goncalves_model_data$Infections, prob = median_risk)
  simulation_median[i,1:infection_number] <- new_entry
}


# severe & moderate disease
for(i in 1:10000){
  new_entry <- rbinom(n=infection_number, size=goncalves_model_data$Supp_Infections, prob = mean_mod_risk)
  simulation_moderate_mean[i,1:infection_number] <- new_entry
}

for(i in 1:10000){
  new_entry <- rbinom(n=infection_number, size=goncalves_model_data$Supp_Infections, prob = median_mod_risk)
  simulation_moderate_median[i,1:infection_number] <- new_entry
}


# severe &moderate disease with denominators from main figure
for(i in 1:10000){
  new_entry <- rbinom(n=infection_number, size=goncalves_model_data$Infections, prob = mean_mod_risk_main_denom)
  simulation_moderate_main_denom_mean[i,1:infection_number] <- new_entry
}

for(i in 1:10000){
  new_entry <- rbinom(n=infection_number, size=goncalves_model_data$Infections, prob = median_mod_risk_main_denom)
  simulation_moderate_main_denom_median[i,1:infection_number] <- new_entry
}


# put them dataframes together

big_boy <- rbind(simulation_mean,
                 simulation_median,
                 simulation_moderate_mean,
                 simulation_moderate_median,
                 simulation_moderate_main_denom_mean,
                 simulation_moderate_main_denom_median)

#long format for ggplot, replace integers with words  
long_simulation <- tidyr::pivot_longer(big_boy, cols=all_of(n_infection_words), names_to = "n_infection", values_to = "severe_cases")


bad_numbers <- n_infection_words
good_numbers <- as.character(seq(1:length(bad_numbers)))

long_simulation$n_infection_num <- as.numeric(stringr::str_replace(long_simulation$n_infection, bad_numbers, good_numbers))


#create summary dfs for mean, median and confidence intervals; 2simga=95% CI; 3sigma=99.7% CI;
summary_df <- long_simulation %>%
  group_by(Simulation, n_infection)%>%
  summarise("mean"=mean(severe_cases), "sd"=sd(severe_cases))%>%
  mutate("mean_plus2"=mean+(sd*2))%>%
  mutate("mean_minus2"=mean-(sd*2))%>%
  mutate("mean_plus3"=mean+(sd*3))%>%
  mutate("mean_minus3"=mean-(sd*3))

# %>%
#   mutate("n_infection_num"=c(8,11,5,1,4,9,2,7,6,10,3))

long_simulation$sim_mean <- summary_df$mean[match(paste(long_simulation$Simulation, long_simulation$n_infection), paste(summary_df$Simulation, summary_df$n_infection))]

long_simulation$mean_plus2 <- summary_df$mean_plus2[match(paste(long_simulation$Simulation, long_simulation$n_infection), paste(summary_df$Simulation, summary_df$n_infection))]

long_simulation$mean_minus2 <- summary_df$mean_minus2[match(paste(long_simulation$Simulation, long_simulation$n_infection), paste(summary_df$Simulation, summary_df$n_infection))]

long_simulation$mean_plus3 <- summary_df$mean_plus3[match(paste(long_simulation$Simulation, long_simulation$n_infection), paste(summary_df$Simulation, summary_df$n_infection))]

long_simulation$mean_minus3 <- summary_df$mean_minus3[match(paste(long_simulation$Simulation, long_simulation$n_infection), paste(summary_df$Simulation, summary_df$n_infection))]


long_simulation$Simulation <- factor(long_simulation$Simulation, levels=unique(long_simulation$Simulation))

long_simulation$n_infection_num <- as.numeric(long_simulation$n_infection_num)
# summary_df_mean$mean_plus2 <- summary_df_mean$mean+(summary_df_mean$sd)*2
# summary_df_mean$mean_minus2 <- summary_df_mean$mean-(summary_df_mean$sd)*2
# 
# summary_df_mean$mean_plus <- summary_df_mean$mean+summary_df_mean$sd
# summary_df_mean$mean_minus <- summary_df_mean$mean-summary_df_mean$sd
# 
# summary_df_mean$n_infection_num <- c(5, 1, 4, 2, 3)
# 

```

There was a mismatch in the number of total cases reported at 1st, 2nd, 3rd infections etc. I therefore included both denominators for summary value calculation to test six "overall probabilities" of severe/moderate disease:

  1. the sum of severe cases divided by the sum of total cases: `r toString(round(mean_risk, digits=4))`
  2. the median of all non-zero probabilities shown in the red bar graph above: `r toString(round(median_risk, digits=4))`
  3. the sum of all moderate/severe cases divided by the sum of cases reported in the supplementary: `r toString(round(mean_mod_risk, digits=4))`
  4. the median of all non-zero probabilities shown in the blue bar graph above: `r toString(round(median_mod_risk, digits=4))`
  5. the sum of all moderate/severe cases divided by the sum of cases reported in the main paper: `r toString(round(mean_mod_risk_main_denom, digits=4))`
  6. the median of all non-zero probabilities of moderate/severe disease using the main paper denominators: `r toString(round(median_mod_risk_main_denom, digits=4))`


Given these probabilities, we ask how often one would observe severe disease, if X number of malaria cases are recorded. X in this instance is the total number of first, second, third etc. cases of malaria reported in the main paper / supplementary. This process is repeated 10,000 times.

The plot below shows the distribution of simulated results as violin plots. The mean value of each violin plot is shown in blue, the area of two standard deviations (95% confidence interval) in light grey. The actual values observed in the paper are shown in red for severe cases and blue for moderate/severe cases. For severe cases, the observed value is within the 95% confidence interval, but only just- moderate/severe cases are outwith the 95% confidence interval in first infection regardless of how the mean/median probability was calculated.

```{r simulation plot, fig.height = 11, fig.width = 12, fig.align = "center", echo=FALSE}
multi_facet_plot <- ggplot(long_simulation, aes(x=factor(n_infection, levels=n_infection_words), y=severe_cases))+
  facet_wrap(~Simulation, ncol=2)+
  geom_violin()+
  geom_line(aes(x=factor(n_infection, levels=n_infection_words), y=sim_mean), colour="lightgrey", inherit.aes = FALSE)+
  geom_point(data=goncalves_model_data, aes(x = N_Infection_Words, y=Severe), alpha=c(rep(1,12),rep(0,24)), color="red", inherit.aes = FALSE)+
  geom_point(data=goncalves_model_data, aes(x = N_Infection_Words, y=Severe_Moderate), alpha=c(rep(0,12),rep(1,24)), color="blue", inherit.aes = FALSE)+
  xlab("Order of Infection")+
  ylab("Number of Severe / Moderate Cases\n")+
  #geom_ribbon(aes(x=n_infection_num, ymin = mean_minus3, ymax = mean_plus3), alpha = 0.3, inherit.aes = FALSE)+
  geom_ribbon(aes(x=n_infection_num, ymin = mean_minus2, ymax = mean_plus2), alpha = 0.2, inherit.aes = FALSE)+
#guides(color=guide_legend(labels=c("Severe", "Moderate / Severe"),c ))
  theme_minimal()+
  theme(legend.position="right",
        strip.text = element_text(size=15, hjust = 0.5),
        axis.text = element_text(size=12),
        axis.title = element_text(size=13.5)
        #plot.margin = unit(c(2,2,2,2), "lines")
        )


plot(multi_facet_plot)

# rmarkdown::render(input = "~/code_space/R/postdoc/goncalves_modelling/binomial_model_with_moderate.Rmd",
#                   output_file = "~/postdoc/goncalves_modelling/markdown/binomial_model_with_moderate.html",
#                   output_format = "html_document")
# 
# rmarkdown::render(input = "~/code_space/R/postdoc/goncalves_modelling/binomial_model_with_moderate.Rmd",
#                   output_file = "~/postdoc/goncalves_modelling/markdown/binomial_model_with_moderate.pdf",
#                   output_format = "pdf_document")
```



